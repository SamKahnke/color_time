<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="/src/nd-ct-game-field.html">
<link rel="import" href="/src/nd-ct-dashboard.html">

<dom-module id="nd-ct-app">
  <template>
    <style>
      :host {
      }
    </style>

    <nd-ct-dashboard id="dashboard"></nd-ct-dashboard>
    <nd-ct-game-field id="game-field"></nd-ct-game-field>
  </template>

  <script>
    class NdCtApp extends Polymer.Element {

      static get is() { return 'nd-ct-app'; }

      static get properties() {
        return {
          colorPicked: {
            type: String
          },
          colorAsked: {
            type: String
          },
          numBlocks: {
            type: Number,
            value: 5
          },
          isCorrect: {
            type: Boolean
          },
          messageText: {
            type: String
          },
          messageColor: {
            type: String
          },
          pauseTime: {
            type: Number,
            value: 1500
          },
          allowClicks: {
            type: Boolean,
            value: true
          }
        };
      }

      ready() {
        super.ready();

        let elems = {
          gameField: this.shadowRoot.getElementById('game-field'),
          dashboard: this.shadowRoot.getElementById('dashboard'),
          allColorBlocks: this.shadowRoot.getElementById('game-field').shadowRoot.childNodes[2],
          timer: this.shadowRoot.getElementById('dashboard').shadowRoot.getElementById('timer')
        }

        this._setUpGame(elems);
      }

      disconnectedCallback() {
        super.disconnectedCallback();
        this.removeEventListener('getColorPicked');
        this.removeEventListener('getColorAsked');
      }

      _setUpGame(elems) {
        this._addListeners(elems);
        this._setUpGameField(elems);
      }

      _setUpGameField(elems) {
        elems.gameField.setAttribute('number-of-blocks', this.numBlocks);
        elems.gameField.setUpGameField();
      }

      _addListeners(elems) {
        this.addEventListener('getColorPicked', e => {
          this.colorPicked = e.detail.colorPicked;
          if (this.allowClicks == true) {
            this._pauseAndResetTimer(elems);
            this._judgeResponse();
            this._displayResponseMessage(elems);
            this._resetQuestion(elems);
          }
          this.allowClicks = false;
        });

        this.addEventListener('getColorAsked', e => {
          this.colorAsked = e.detail.colorAsked;
          this.allowClicks = true;
          this._displayQuestionMessage(elems);
          elems.timer.start();
        });
      }

      _judgeResponse() {
        this.isCorrect = (this.colorPicked === this.colorAsked) ? true : false;
      }

      _displayQuestionMessage(elems) {
        this.messageText = 'Pick the ' + this.colorAsked + ' square';
        this.messageColor = 'black';

        elems.dashboard.setAttribute('message-text', this.messageText);
        elems.dashboard.setAttribute('message-color', this.messageColor);
      }

      _displayResponseMessage(elems) {
        let correctMessage = 'Correct!';
        let incorrectMessage = 'Wrong! You picked ' + this.colorPicked + '.';

        if (this.isCorrect) {
          this.messageText = correctMessage;
          this.messageColor = 'green';
        } else {
          this.messageText = incorrectMessage;
          this.messageColor = 'red';
        }

        elems.dashboard.setAttribute('message-text', this.messageText);
        elems.dashboard.setAttribute('message-color', this.messageColor);
      }

      _resetQuestion(elems) {
        setTimeout(() => {this._refreshElements(elems)}, this.pauseTime);
      }

      _pauseAndResetTimer(elems) {
        elems.timer.pause();
        elems.timer.currentTime = elems.timer.startTime;
      }

      _refreshElements(elems) {
        this._emptyGameField(elems);
        this._setUpGameField(elems);
      }

      _emptyGameField(elems) {
        elems.allColorBlocks.innerHTML = '';
      }
      
    }

    window.customElements.define(NdCtApp.is, NdCtApp);
  </script>
</dom-module>